<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic
  PUBLIC "-//OASIS//DTD DITA Topic//EN" "http://docs.oasis-open.org/dita/v1.1/OS/dtd/topic.dtd" ><topic xml:lang="en-us" id="topic10581">

<title>HP Helion <tm tmtype="reg">OpenStack</tm> Carrier Grade 2.0 Beta: Configuring 5930 Switch to
    Support PCI-PT/SR-IOV/Baremetal Ports</title>

<prolog>
  <metadata>
    <othermeta name="layout" content="default"/>
    <othermeta name="product-version" content="HP Helion OpenStack Carrier Grade 1.1"/>
    <othermeta name="role" content="Storage Administrator"/>
    <othermeta name="role" content="Storage Architect"/>
    <othermeta name="role" content="Michael B"/>
    <othermeta name="product-version1" content="HP Helion OpenStack Carrier Grade 1.1"/>
  </metadata>
</prolog>
<body>
    <section>
      <title>Overview</title>
      <p>This document provides a sequence of events to understand how VMs with vNIC type PCI-PT or
        SRIOV is orchestrated to provide:</p>
      <ul>
        <li>IP assignment to the vNICs from the tenant network pool</li>
        <li>
          <p>vNICs are part of VSD managed subnet (VxLAN segment) to allow communication between a
            VM with virtio vNIC, a VM with SRIOV vNIC and a VM with PCI-PT vNIC in the same l2
            domain. See the figure:</p>
        </li>
      </ul>
      <p><image href="../../../media/CGH-install-5930-diagram.png" id="image_uyn_rzr_zt" width="600"
        /></p>
    </section>
    <section>
      <title>Initial Configuration and Data Collection</title>
      <p>After HP Helion OpenStack Carrier Grade is deployed, perform the following tasks. </p>
    </section>
    <p><b>Identify the Switch and configure compute nodes with specific Interfaces as PCI-PT or
        SRIOV</b></p>
    <p>Based on your sizing and capacity planning, dedicate a few compute nodes and/or Rack with ToR
      Switch for the purpose of providing PCI-Passthrough or SR-IOV vNIC types to the guest VM or
      VNFs. The administrator can use the <codeph>system</codeph> CLI or the Horizon UI to provide
      this assignment. For example: <ul id="ul_jc4_ks5_15">
        <li>To assign <codeph>eth7</codeph> on <codeph>mem17-compute1</codeph> as and  SR-IOV
          interface with four virtual Ethernet device (called virtual functions or VFs), execute the
          following command:
          <codeblock>system host-if-modify -nt pci-sriov -N 4 -p physnet1 mem17-compute1 eth7</codeblock></li>
        <li>To assign <codeph>eth8</codeph> on <codeph>mem17-compute1</codeph> as a PCI-Passthrough
          interface, execute the following command:
          <codeblock>system host-if-modify -nt pci-passthrough -p physnet1 mem17-compute1 eth8</codeblock></li>
      </ul></p>
    <p>Refer to the <xref
        href="http://gaf2871b9d2d13cf45c1306b35bf01764.cdn.hpcloudsvc.com/CGH-2-KVM-Admin.pdf"
        format="pdf" scope="external">KVM Region Administrator Guide</xref> for more information on
      configuring these interfaces and instructions for using the Horizon UI to perform these
      tasks.</p>
    <p><b>Configure ToR Switch</b></p>
    <p>You need to make sure that the ToR switch has up-to-date firmware to support VxLAN-VLAN
      bridging.</p>
    <ol id="ol_w52_4yr_zt">
      <li>Download and update firmware for the HP FlexFabric 5930 switch assigned for the rack that
        hosts PCI-PT and SR-IOV capable compute nodes. The current version is
          <codeph>5930-D2413-1111.ipe</codeph>. <p>FTP Access : <xref
            href="ftp://cmwbits:MN6cz=YK@h2.usa.hp.com" format="html" scope="external"
            >ftp://cmwbits:MN6cz=YK@h2.usa.hp.com</xref></p><p><b>Note: </b>This package is updated,
          so do not use the one shipped with HCG Beta tarball</p></li>
      <li>Validate that the firmware has been updated successfully: Display Boot-Loader to confirm
        firmware is applied currently or will be next boot. For
        example:<codeblock>dis boot-loader
Software images on slot 1: 
Current software images: 
flash:/5930-cmw710-boot-d2423.bin 
flash:/5930-cmw710-system-d2423.bin 
flash:/5930-cmw710-devkit-d2423.bin 
flash:/5930-cmw710-manufacture-d2423.bin</codeblock></li>
      <li>Enable L2/L3 OVSDB server and set up connectivity to VSC:
            <codeblock># 805 is untagged VLAN for TUL interface
Vlan-interface805 
ip address 10.80.5.250 255.255.255.0 
# Enable L2/L3 OVSDB 
l2vpn enable 
vtep enable 
## Assign a TUL IP to 5930. This acts as VTEP Gateway IP and shows up in VSD > Infrastructure. Pick one unused IP from TUL Range. 
tunnel global source-address 10.80.5.250 
vxlan local-mac report 
ovsdb server tcp 10.80.5.31 port 6640 
ovsdb server enable 
dhcp enable </codeblock><p><b>NOTE</b>:
          FOR HA add second VSC ip line for ovsdb server. Here, 10.80.5.31 is VSC TUL IP</p></li>
      <li>Allow DHCP packet to CPU: <!--This is a temporary fix. Future releases might not need this step.-->
        <codeblock>acl number 3001
rule 0 permit udp destination-port eq bootps 
traffic classifier dhcp operator and 
if-match acl 3001 
traffic behavior count 
accounting packet 
redirect cpu 
qos policy dhcp 
classifier dhcp behavior 
count qos apply policy dhcp global inbound</codeblock></li>
      <li>Configure Switch Ports as VTEP Access Port
        <p>By doing so, the participating switch ports
          (connected to the host ports that are configured either as SRIOV or PCIPT devices) can now
          viewed in VSD and programmed through it.</p>
        <codeblock>
interface Ten-GigabitEthernet 1/0/19:4
vtep access port 
interface Ten-GigabitEthernet 2/0/23:4 
vtep access port 

#Example, 
#For SRIOV Switch Port the complete configuration must look like: 
#interface Ten-GigabitEthernet1/0/19:4 
#port link-mode bridge 
#port link-type trunk 
#port trunk permit vlan 805 810 to 817 
#port trunk pvid vlan 805 
#vtep access port 

#For Baremetal/PCI-PT port the complete configuration must look like: 
#interface Ten-GigabitEthernet2/0/23:4 
#port link-mode bridge 
#port access vlan 805 
#vtep access port 
#Note. You must have noticed that switch port for PCI-PT and SRIOV assigned nic ports have two differences: 
#1. SRIOV switch port expects a tagged traffic from the compute node whereas PCI-PT doesn't. Hence, SRIOV switch port is in trunk mode and PCI-PT in Access. 
#2. In trunk mode, specific VLANID is allowed in the SR-IOV Switch Port, in this example 810 to 817. These VLANs are defined in neutron's VLAN tenant network. 
#3. With recent HPN drops, we don't have to differentiate between SR-IOV and/or PCI-PT switch ports (here, 805 is for untagged vlan, 810 to 817 are provider VLANs specifically used to identify sriov virtual functions): 
    interface Ten-GigabitEthernet1/0/19:4 
    port link-mode bridge 
    port link-type trunk 
    port trunk permit vlan 805 810 to 817 
    port trunk pvid vlan 805 
    vtep access port</codeblock></li>

      <li>
        <p>Configure Service service loopback group, required only for 5930</p>
        <p>Configure a service loopback group per slot. This is used for VxLAN-VLAN bridging, hence
          recommendation is to use 40G Port.</p>
        <table id="table_bv2_4yr_zt">
          <tgroup cols="1">
            <colspec colnum="1" colname="col1"/>
            <tbody>
              <row>
                <entry>
                  <codeblock>service-loopback group </codeblock>
                  <codeblock>1</codeblock>
                  <codeblock>type vsi-gateway</codeblock>
                  <codeblock>reserve-vlan-</codeblock>
                  <codeblock>interface</codeblock>
                  <codeblock>4000</codeblock>
                  <codeblock>to </codeblock>
                  <codeblock>4020</codeblock>
                  <codeblock>interface</codeblock>
                  <codeblock>FortyGigE1/</codeblock>
                  <codeblock>0</codeblock>
                  <codeblock>/</codeblock>
                  <codeblock>4</codeblock>
                  <codeblock> </codeblock>
                  <codeblock>port
                                  link-mode bridge</codeblock>
                  <codeblock> </codeblock>
                  <codeblock>port
                                  service-loopback group </codeblock>
                  <codeblock>1</codeblock>
                </entry>
              </row>
            </tbody>
          </tgroup>
        </table>
        <p><b>Note:</b> Use multiple physical port per service-loopback group to give more
          bandwidth. Specifically for L3 communication. Do this per slot, if need be.</p>
      </li>
      <li>On board the ToR as VTEP Gateway in VSD<ol id="ol_cv2_4yr_zt">
          <li>Using VSD Architect Dashboard, click on 'Open Platform Configuration' icon</li>
          <li>
            <p>Go to Infrastructure &gt; Gateways &gt; Pending Gateways &gt; Click on 'Use this
              gateway' icon (down arrow)</p>
            <p><b>Note: </b>You can now see all the ports marked as VTEP Access port under the
              gateway.</p>
          </li>
        </ol></li>
    </ol>
    <p><b>Discover Datacenter Network Topology --&gt; HP Software UCMDB</b></p>
    <p>Presumably, this mapping data is collected by OMi and stored in <i>HP</i> Universal CMDB
      Configuration Manager (<i>UCMDB</i> CM)CMDB and dynamically updated on periodic bases. For
      Orchestrator to configure a specific switch <b>port</b> (applicable for PCI-PT or baremetal
      node use cases) or switch <b>port,vlan</b> (applicable for SR-IOV use case ), it needs to
      understand or map the following (specifically aware of the highlighted mapping):</p>
    <ul id="ul_dv2_4yr_zt">
      <li>
        <p>For SRIOV</p>
        <p> VM --&gt; Neutron Port --&gt; <b>Compute Node --&gt; Virtual Function --&gt; Physical
            Function/Host Port ---&gt; Switch Port --&gt; ToR VTEP Gateway</b></p>
      </li>
    </ul>
    <ul id="ul_ev2_4yr_zt">
      <li>
        <p>For PCI-PT or Baremetal Port</p>
        <p> VM --&gt; Neutron Port --&gt; <b>Compute Node --&gt; Host Port ---&gt; Switch Port
            --&gt; ToR VTEP Gateway</b></p>
      </li>
    </ul>
    <p>An inventory of this format is recorded in CMDB:</p>
    <table id="table_fv2_4yr_zt">
      <tgroup cols="8">
        <colspec colnum="1" colname="col1"/>
        <colspec colnum="2" colname="col2"/>
        <colspec colnum="3" colname="col3"/>
        <colspec colnum="4" colname="col4"/>
        <colspec colnum="5" colname="col5"/>
        <colspec colnum="6" colname="col6"/>
        <colspec colnum="7" colname="col7"/>
        <colspec colnum="8" colname="col8"/>
        <thead>
          <row>
            <entry>Interface Type</entry>
            <entry>Compute Node</entry>
            <entry>VF</entry>
            <entry>PF/ PCI Port</entry>
            <entry>MAC Address Host Port</entry>
            <entry>Switch Port</entry>
            <entry>ToR VTEP IP</entry>
            <entry>ToR MGMT IP</entry>
          </row>
        </thead>
        <tbody>
          <row>
            <entry>PCI-SRIOV</entry>
            <entry>compute-1</entry>
            <entry>0000:08:13.7</entry>
            <entry>0000:08:00.1</entry>
            <entry>8c:<xref href="http://dcd4ac:67:25" format="html" scope="external"
                >dc:d4:ac:67:25</xref></entry>
            <entry>1/0/19:4</entry>
            <entry>10.80.5.250</entry>
            <entry>10.1.2.96</entry>
          </row>
          <row>
            <entry>PCI-PT</entry>
            <entry>compute-1</entry>
            <entry>NA</entry>
            <entry>0000:87:00.0</entry>
            <entry>8c:<xref href="http://dcd4ac:68:54" format="html" scope="external"
                >dc:d4:ac:68:54</xref></entry>
            <entry>2/0/23:4</entry>
            <entry>10.80.5.250</entry>
            <entry>10.1.2.96</entry>
          </row>
        </tbody>
      </tgroup>
    </table>
    <p><b>CLIs to capture mapping information from Compute Node:</b></p>
    <p>For SRIOV</p>
    <table id="table_gv2_4yr_zt">
      <tgroup cols="1">
        <colspec colnum="1" colname="col1"/>
        <tbody>
          <row>
            <entry>
              <codeblock># grab the
                              </codeblock>
              <codeblock>'name'</codeblock>
              <codeblock>, </codeblock>
              <codeblock>for</codeblock>
              <codeblock>example eth7; </codeblock>
              <codeblock>4</codeblock>
              <codeblock>is the compute node ID</codeblock>
              <codeblock>system
                              host-</codeblock>
              <codeblock>if</codeblock>
              <codeblock>-list </codeblock>
              <codeblock>4</codeblock>
              <codeblock>| grep pci-sriov </codeblock>
              <codeblock># grab the
                              UUID</codeblock>
              <codeblock>system host-port-list </codeblock>
              <codeblock>4</codeblock>
              <codeblock>I grep eth7 </codeblock>
              <codeblock># grab the
                              imac of eth7</codeblock>
              <codeblock>system host-</codeblock>
              <codeblock>if</codeblock>
              <codeblock>-show </codeblock>
              <codeblock>4</codeblock>
              <codeblock>fdb4b7cf-6b8b-421a-bdc2-a07209a31548 | grep
                              imac</codeblock>
              <codeblock># </codeblock>
              <codeblock>this</codeblock>
              <codeblock>output will give you PF to VF
                            mapping</codeblock>
              <codeblock>system host-port-show </codeblock>
              <codeblock>4</codeblock>
              <codeblock>&lt;uuid&gt;  </codeblock>
            </entry>
          </row>
        </tbody>
      </tgroup>
    </table>
    <p>For PCI-PT</p>
    <table id="table_hv2_4yr_zt">
      <tgroup cols="1">
        <colspec colnum="1" colname="col1"/>
        <tbody>
          <row>
            <entry>
              <codeblock># grab the
                              </codeblock>
              <codeblock>'name'</codeblock>
              <codeblock>, </codeblock>
              <codeblock>for</codeblock>
              <codeblock>example eth7; </codeblock>
              <codeblock>4</codeblock>
              <codeblock>is the compute node ID</codeblock>
              <codeblock>system
                              host-</codeblock>
              <codeblock>if</codeblock>
              <codeblock>-list </codeblock>
              <codeblock>4</codeblock>
              <codeblock>| grep pci-passthrough </codeblock>
              <codeblock># grab the
                              UUID</codeblock>
              <codeblock>system host-port-list </codeblock>
              <codeblock>4</codeblock>
              <codeblock>| grep eth7 </codeblock>
              <codeblock># grab the
                              imac</codeblock>
              <codeblock>system host-port-show </codeblock>
              <codeblock>4</codeblock>
              <codeblock>c4cb43cd-bddd-</codeblock>
              <codeblock>4999</codeblock>
              <codeblock>-bab5-2f0db8e6ac2f | grep
                              imac</codeblock>
              <codeblock># </codeblock>
              <codeblock>this</codeblock>
              <codeblock>output will give you pci
                            address</codeblock>
              <codeblock>system host-port-show </codeblock>
              <codeblock>4</codeblock>
              <codeblock>&lt;uuid&gt;  </codeblock>
            </entry>
          </row>
        </tbody>
      </tgroup>
    </table>
    <p><b>Create an L3 domain in VSD and DHCP Server Pool in ToR ---&gt; Orchestration through
        NFV-D</b></p>
    <ol id="ol_iv2_4yr_zt">
      <li>
        <p>Create an L3 domain in VSD. This will be orchestrated by NFV-D.</p>
      </li>
      <li>
        <p>Get the Service ID by right clicking the l3 domain &gt; Inspect</p>
        <p> </p>
      </li>
      <li>
        <p>Create a DHCP Server Pool on ToR Switch Per L3 domain using prefixed the service id with
          vrf </p>
        <table id="table_jv2_4yr_zt">
          <tgroup cols="1">
            <colspec colnum="1" colname="col1"/>
            <tbody>
              <row>
                <entry>
                  <codeblock>dhcp
                                  server ip-pool mkt-l3-dom1</codeblock>
                  <codeblock>  </codeblock>
                  <codeblock>vpn-instance
                                vrf20001</codeblock>
                </entry>
              </row>
            </tbody>
          </tgroup>
        </table>
      </li>
    </ol>
    <p><b>Create networks and subnets - Orchestration through NFV-D</b></p>
    <ol id="ol_kv2_4yr_zt">
      <li>Create a VSD Managed Subnet: Create a subnet under Private zone and grab the VSD ID
        (right-click Inspect). For example, 50.50.50.0/24 CIDR</li>
      <li>
        <p>Create a VxLAN Tenant network and subnet for Virtio vNICs: This network will be used for
          launching VMs with VirtIO vNICs. It is a VxLAN tenant network created using VSD ID
          (--nuagenet)</p>
        <table id="table_lv2_4yr_zt">
          <tgroup cols="1">
            <colspec colnum="1" colname="col1"/>
            <tbody>
              <row>
                <entry>
                  <codeblock>neutron
                                  net-create mkt-net1</codeblock>
                  <codeblock>neutron
                                  subnet-create mkt-net1 </codeblock>
                  <codeblock>50.50</codeblock>
                  <codeblock>.</codeblock>
                  <codeblock>50.0</codeblock>
                  <codeblock>/</codeblock>
                  <codeblock>24</codeblock>
                  <codeblock>--nuagenet
                                  0c806349-27ee-440a-a8fd-b5cb144fb3b6 --net-partition Marketing
                                  --enable-dhcp</codeblock>
                </entry>
              </row>
            </tbody>
          </tgroup>
        </table>
      </li>
      <li>
        <p>Create a neutron network and subnet for PCI-PT/SRIOV vNICs: This network will be used for
          launching VMs with baremetal ports like SRIOV, PCI-PT. This is a VLAN tenant network. In
          this example, a VLAN 814 is used and provider net is physnet1. The same alias 'physnet1'
          is used when assigning interfaces for PCI-PT/SRIOV.</p>
        <table id="table_mv2_4yr_zt">
          <tgroup cols="1">
            <colspec colnum="1" colname="col1"/>
            <tbody>
              <row>
                <entry>
                  <codeblock>neutron
                                  net-create mkt-sriov-pcipt-net --provider:network_type vlan
                                  --provider:segmentation_id </codeblock>
                  <codeblock>814</codeblock>
                  <codeblock>--provider:physical_network
                                physnet1</codeblock>
                  <codeblock>neutron subnet-create
                                  8614d6fd-ad8c-442a-8af4-2991173cfe6b </codeblock>
                  <codeblock>50.50</codeblock>
                  <codeblock>.</codeblock>
                  <codeblock>50.0</codeblock>
                  <codeblock>/</codeblock>
                  <codeblock>24</codeblock>
                  <codeblock>#net-id
                                  returned here is
                              8614d6fd-ad8c-442a-8af4-2991173cfe6b</codeblock>
                </entry>
              </row>
            </tbody>
          </tgroup>
        </table>
        <p><b>Note</b> As same CIDR is used for both VxLAN and VLAN tenant networks, unique IP
          address allocation is managed by infoblox IPAM Plugin.</p>
      </li>
    </ol>
    <p><b>Sequence of events during VM Provisioning using SRIOV vNIC - Orchestration through
        NFV-D</b></p>
    <p>NFV-D orchestrated the provisioning of VM using OpenStack APIs. Here is the sequence:</p>
    <ol id="ol_nv2_4yr_zt">
      <li>
        <p>Launch VM using virtio SR-IOV vNIC</p>
        <table id="table_ov2_4yr_zt">
          <tgroup cols="1">
            <colspec colnum="1" colname="col1"/>
            <tbody>
              <row>
                <entry>
                  <codeblock># Nova
                                  boot using vif-model </codeblock>
                  <codeblock>nova boot
                                  mkt-sriov-vm --image wr-</codeblock>
                  <codeblock>new</codeblock>
                  <codeblock>--flavor m1.small --nic
                                  net-id=8614d6fd-ad8c-442a-8af4-2991173cfe6b,vif-model=pci-sriov
                                  --availability-zone c1</codeblock>
                  <codeblock># Returns
                                  the UUID. </codeblock>
                  <codeblock># It is recommended to launch a VM with a
                                  managment port being virtio vNIC and data ports as pci-pt or
                                  pci-sriov</codeblock>
                </entry>
              </row>
            </tbody>
          </tgroup>
        </table>
      </li>
      <li>
        <p>Get the compute node where the VM Launched and SRIOV port UUID</p>
        <table id="table_pv2_4yr_zt">
          <tgroup cols="1">
            <colspec colnum="1" colname="col1"/>
            <tbody>
              <row>
                <entry>
                  <codeblock>nova show
                                </codeblock>
                  <codeblock># Get hypervisor_hostname and sriov port
                                  UUID</codeblock>
                  <codeblock>| OS-EXT-SRV-ATTR:hypervisor_hostname  |
                                  mem17-compute1  </codeblock>
                  <codeblock>|
                                  wrs-</codeblock>
                  <codeblock>if</codeblock>
                  <codeblock>:nics                          |
                                  {</codeblock>
                  <codeblock>"nic1"</codeblock>
                  <codeblock>: {</codeblock>
                  <codeblock>"vif_model"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>null</codeblock>
                  <codeblock>,
                                  </codeblock>
                  <codeblock>"mac_address"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>"fa:16:3e:b9:e2:cb"</codeblock>
                  <codeblock>,
                                  </codeblock>
                  <codeblock>"port_id"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>"67ba96d1-ab14-4649-a92f-7a469a1c8992"</codeblock>
                  <codeblock>, </codeblock>
                  <codeblock>"network"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>"mkt-pcipt-net"</codeblock>
                  <codeblock>, </codeblock>
                  <codeblock>"mtu"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>null</codeblock>
                  <codeblock>}}
                                  |</codeblock>
                </entry>
              </row>
            </tbody>
          </tgroup>
        </table>
        <p><b>NOTE: </b>Currently, the way to identify whether it is sriov v/s pci-pt vNIC is as
          follows:</p>
        <ol id="ol_qv2_4yr_zt">
          <li>mac address: if starting ‘fa’, sriov, other than that pci-pt</li>
          <li>network: all pci-pt and sriov will land on vlan network. If above condition is met, we
            double-check whether it belongs the vlan network. </li>
        </ol>
        <p> </p>
      </li>
      <li>
        <p>Get the VF PCIBusID, IP, MAC and VLAN Tag </p>
        <table id="table_rv2_4yr_zt">
          <tgroup cols="1">
            <colspec colnum="1" colname="col1"/>
            <tbody>
              <row>
                <entry>
                  <codeblock>neutron
                                  port-show </codeblock>
                  <codeblock>"67ba96d1-ab14-4649-a92f-7a469a1c8992"</codeblock>
                  <codeblock># Get the
                                  IP, MAC, PCI_Slot and VLANID </codeblock>
                  <codeblock>|
                                  binding:profile       | {</codeblock>
                  <codeblock>"pci_request_id"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>"2c2cfcee-7a1a-49ce-8975-7df92f2771aa"</codeblock>
                  <codeblock>, </codeblock>
                  <codeblock>"dev_type"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>"type-VF"</codeblock>
                  <codeblock>,
                                  </codeblock>
                  <codeblock>"pci_slot"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>"0000:08:13.5"</codeblock>
                  <codeblock>, </codeblock>
                  <codeblock>"physical_network"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>"physnet1"</codeblock>
                  <codeblock>, </codeblock>
                  <codeblock>"pci_vendor_info"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>"8086:10ed"</codeblock>
                  <codeblock>} |</codeblock>
                  <codeblock>|
                                  binding:vif_details   | {</codeblock>
                  <codeblock>"port_filter"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>false</codeblock>
                  <codeblock>,
                                  </codeblock>
                  <codeblock>"vlan"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>"814"</codeblock>
                  <codeblock>}                                                                                                                                        
                                </codeblock>
                  <codeblock>| fixed_ips             |
                                  {</codeblock>
                  <codeblock>"subnet_id"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>"ca2d8853-3f04-448a-8de5-87458304f312"</codeblock>
                  <codeblock>, </codeblock>
                  <codeblock>"ip_address"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>"50.50.50.103"</codeblock>
                  <codeblock>}                                                                                          
                                </codeblock>
                  <codeblock>| id                    |
                                  67ba96d1-ab14-</codeblock>
                  <codeblock>4649</codeblock>
                  <codeblock>-a92f-7a469a1c8992                                                                                                                                         
                                </codeblock>
                  <codeblock>| mac_address           |
                                  fa:</codeblock>
                  <codeblock>16</codeblock>
                  <codeblock>:3e:b9:e2:cb                                                       
                                </codeblock>
                </entry>
              </row>
            </tbody>
          </tgroup>
        </table>
      </li>
      <li>
        <p>Using PCIBusID of VF, get the PF PCIBusID and Switch Port and compute node inputs, query
          CMDB to get PF and Switch Port it is connected to</p>
        <table id="table_sv2_4yr_zt">
          <tgroup cols="7">
            <colspec colnum="1" colname="col1"/>
            <colspec colnum="2" colname="col2"/>
            <colspec colnum="3" colname="col3"/>
            <colspec colnum="4" colname="col4"/>
            <colspec colnum="5" colname="col5"/>
            <colspec colnum="6" colname="col6"/>
            <colspec colnum="7" colname="col7"/>
            <thead>
              <row>
                <entry>Interface Type</entry>
                <entry>Compute Node</entry>
                <entry>VF</entry>
                <entry>PF/ PCI Port</entry>
                <entry>Switch Port</entry>
                <entry>ToR VTEP IP</entry>
                <entry>ToR MGMT IP</entry>
              </row>
            </thead>
            <tbody>
              <row>
                <entry>PCI-SRIOV</entry>
                <entry>compute-1</entry>
                <entry>0000:08:13.7</entry>
                <entry>0000:08:00.1</entry>
                <entry>1/0/19:4</entry>
                <entry>10.80.5.250</entry>
                <entry>10.1.2.96</entry>
              </row>
            </tbody>
          </tgroup>
        </table>
      </li>
      <li>
        <p>Using VSD Dashboard or API create VLAN 814 on the switch port and grant privileges to the
          destination VSD Org where VM is launched</p>
        <p>Optional: This step is optional if previous VM provisioning has already created the same
          type vlan on the same port. </p>
      </li>
      <li>
        <p>Add the <b>port,vlan</b> to the VxLAN tenant Network as Bridge vPort. See the
          screenshot</p>
        <p>Optional: This step is optional if previous VM provisioning has already created the same
          type vlan on the same port. </p>
      </li>
      <li>
        <p>Update the ToR switch with IP MAC reservation for the sriov neutron port</p>
        <table id="table_tv2_4yr_zt">
          <tgroup cols="1">
            <colspec colnum="1" colname="col1"/>
            <tbody>
              <row>
                <entry>
                  <codeblock>dhcp
                                  server ip-pool mkt-l3-dom1</codeblock>
                  <codeblock> </codeblock>
                  <codeblock>vpn-instance
                                vrf20001</codeblock>
                  <codeblock> </codeblock>
                  <codeblock>static</codeblock>
                  <codeblock>-bind ip-address
                                  </codeblock>
                  <codeblock>50.50</codeblock>
                  <codeblock>.</codeblock>
                  <codeblock>50.103</codeblock>
                  <codeblock>mask </codeblock>
                  <codeblock>255.255</codeblock>
                  <codeblock>.</codeblock>
                  <codeblock>255.0</codeblock>
                  <codeblock>hardware-address
                                fa16-3eb9-e2cb</codeblock>
                </entry>
              </row>
            </tbody>
          </tgroup>
        </table>
      </li>
      <li>
        <p>Validate if VM with SRIOV vNIC got an IP</p>
      </li>
    </ol>
    <p><b>Sequence of events during VM Provisioning using PCI-PT vNIC - Orchestration through
        NFV-D</b></p>
    <ol id="ol_uv2_4yr_zt">
      <li>
        <p>Launch VM using PCI-PT vNIC</p>
        <table id="table_vv2_4yr_zt">
          <tgroup cols="1">
            <colspec colnum="1" colname="col1"/>
            <tbody>
              <row>
                <entry>
                  <codeblock># Nova
                                  boot using vif-model </codeblock>
                  <codeblock>nova boot
                                  mkt-pci-pt-vm --image wr-</codeblock>
                  <codeblock>new</codeblock>
                  <codeblock>--flavor m1.small --nic
                                  net-id=8614d6fd-ad8c-442a-8af4-2991173cfe6b,vif-model=pci-passthrough
                                  --availability-zone c1</codeblock>
                  <codeblock># Returns
                                  the UUID. </codeblock>
                  <codeblock># It is recommended to launch a VM with a
                                  managment port being virtio vNIC and data ports as pci-pt or
                                  pci-sriov</codeblock>
                </entry>
              </row>
            </tbody>
          </tgroup>
        </table>
      </li>
      <li>
        <p>Get the compute node where the VM Launched and PCI-PT port UUID</p>
        <table id="table_wv2_4yr_zt">
          <tgroup cols="1">
            <colspec colnum="1" colname="col1"/>
            <tbody>
              <row>
                <entry>
                  <codeblock>nova show
                                </codeblock>
                  <codeblock># Get hypervisor_hostname and pci-pt port
                                  UUID</codeblock>
                  <codeblock>| OS-EXT-SRV-ATTR:hypervisor_hostname  |
                                  mem17-compute1              </codeblock>
                  <codeblock>|
                                  wrs-</codeblock>
                  <codeblock>if</codeblock>
                  <codeblock>:nics                          |
                                  {</codeblock>
                  <codeblock>"nic1"</codeblock>
                  <codeblock>: {</codeblock>
                  <codeblock>"vif_model"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>null</codeblock>
                  <codeblock>,
                                  </codeblock>
                  <codeblock>"mac_address"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>"8c:dc:d4:ac:68:54"</codeblock>
                  <codeblock>,
                                  </codeblock>
                  <codeblock>"port_id"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>"71b44265-ea24-465e-b7e2-c881458d5983"</codeblock>
                  <codeblock>, </codeblock>
                  <codeblock>"network"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>"mkt-pcipt-net"</codeblock>
                  <codeblock>, </codeblock>
                  <codeblock>"mtu"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>null</codeblock>
                  <codeblock>}}
                                  |</codeblock>
                </entry>
              </row>
            </tbody>
          </tgroup>
        </table>
        <p><b>NOTE: </b>Currently, the way to identify whether it is sriov vNIC vs/ pci-pt is as
          follows:</p>
        <ol id="ol_xv2_4yr_zt">
          <li>mac address: if starting ‘fa’, sriov, other than that pci-pt</li>
          <li>
            <p>network: all pci-pt and sriov will land on vlan network. If above condition is met,
              we double-check whether it belongs the vlan network. </p>
          </li>
        </ol>
      </li>
      <li>
        <p>Get the PCI BusID to identify Switch Port</p>
        <table id="table_yv2_4yr_zt">
          <tgroup cols="1">
            <colspec colnum="1" colname="col1"/>
            <tbody>
              <row>
                <entry>
                  <codeblock>neutron
                                  port-show </codeblock>
                  <codeblock>"71755861-c9f8-4198-912b-4c5f7eb2184a"</codeblock>
                  <codeblock># Get the
                                  IP, MAC, PCI_Slot and VLANID </codeblock>
                  <codeblock>|
                                  binding:host_id       |
                                  mem17-compute1                                                                                                                                                                
                                  | binding:profile       | {</codeblock>
                  <codeblock>"pci_request_id"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>"c0bc1760-3e83-4291-b41b-e92a0f13a454"</codeblock>
                  <codeblock>, </codeblock>
                  <codeblock>"dev_type"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>"type-PCI"</codeblock>
                  <codeblock>,
                                  </codeblock>
                  <codeblock>"pci_slot"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>"0000:87:00.0"</codeblock>
                  <codeblock>, </codeblock>
                  <codeblock>"physical_network"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>"physnet1"</codeblock>
                  <codeblock>, </codeblock>
                  <codeblock>"pci_vendor_info"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>"8086:10f8"</codeblock>
                  <codeblock>} |</codeblock>
                  <codeblock>|
                                  fixed_ips             | {</codeblock>
                  <codeblock>"subnet_id"</codeblock>
                  <codeblock>:
                                  </codeblock>
                  <codeblock>"ca2d8853-3f04-448a-8de5-87458304f312"</codeblock>
                  <codeblock>, </codeblock>
                  <codeblock>"ip_address"</codeblock>
                  <codeblock>: </codeblock>
                  <codeblock>"50.50.50.102"</codeblock>
                  <codeblock>}                                                                                           
                                  | mac_address           | 8c:dc:d4:ac:</codeblock>
                  <codeblock>68</codeblock>
                  <codeblock>:</codeblock>
                  <codeblock>54</codeblock>
                </entry>
              </row>
            </tbody>
          </tgroup>
        </table>
      </li>
      <li>
        <p>Using pci_slot and compute node inputs, query CMDB to get Switch Port it is connected
          to</p>
        <table id="table_zv2_4yr_zt">
          <tgroup cols="7">
            <colspec colnum="1" colname="col1"/>
            <colspec colnum="2" colname="col2"/>
            <colspec colnum="3" colname="col3"/>
            <colspec colnum="4" colname="col4"/>
            <colspec colnum="5" colname="col5"/>
            <colspec colnum="6" colname="col6"/>
            <colspec colnum="7" colname="col7"/>
            <thead>
              <row>
                <entry>Interface Type</entry>
                <entry>Compute Node</entry>
                <entry>VF</entry>
                <entry>PF/ PCI Port</entry>
                <entry>Switch Port</entry>
                <entry>ToR VTEP IP</entry>
                <entry>ToR MGMT IP</entry>
              </row>
            </thead>
            <tbody>
              <row>
                <entry>PCI-PT</entry>
                <entry>compute-1</entry>
                <entry>NA</entry>
                <entry>0000:87:00.0</entry>
                <entry>2/0/23:4</entry>
                <entry>10.80.5.250</entry>
                <entry>10.1.2.96</entry>
              </row>
            </tbody>
          </tgroup>
        </table>
      </li>
      <li>
        <p>Using VSD Dashboard or API create VLAN 0 (untagged) on the switch port and grant
          privileges to the destination VSD Org where VM is launched. </p>
      </li>
      <li>
        <p>Add the port,vlan to the VxLAN tenant Network as Bridge vPort. See the screenshot</p>
      </li>
      <li>
        <p>Update the ToR switch with IP MAC reservation for the sriov neutron port</p>
        <table id="table_aw2_4yr_zt">
          <tgroup cols="1">
            <colspec colnum="1" colname="col1"/>
            <tbody>
              <row>
                <entry>
                  <codeblock>dhcp
                                  server ip-pool mkt-l3-dom1</codeblock>
                  <codeblock> </codeblock>
                  <codeblock>vpn-instance
                                vrf20001</codeblock>
                  <codeblock> </codeblock>
                  <codeblock>static</codeblock>
                  <codeblock>-bind ip-address
                                  </codeblock>
                  <codeblock>50.50</codeblock>
                  <codeblock>.</codeblock>
                  <codeblock>50.102</codeblock>
                  <codeblock>mask </codeblock>
                  <codeblock>255.255</codeblock>
                  <codeblock>.</codeblock>
                  <codeblock>255.0</codeblock>
                  <codeblock>hardware-address 8cdc-d4ac-</codeblock>
                  <codeblock>6854</codeblock>
                </entry>
              </row>
            </tbody>
          </tgroup>
        </table>
      </li>
      <li>
        <p>Validate the VM with PCI-PT vNIC got an IP address</p>
      </li>
    </ol>
    <section>
      <p/>
    </section>
  </body>
</topic>
