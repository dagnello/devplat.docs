<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="recover_downed_cluster">
  <title><ph conkeyref="HOS-conrefs/product-title"/>Recovering a Downed Cluster</title>
  <body>
    <p conkeyref="HOS-conrefs/applies-to"/>
    <note type="attention">Hyperlinks intermittently do not work in the Google Chrome browser. <xref
        href="http://docs.hpcloud.com/helion/operations/recover_downed_cluster.html"
        scope="external" format="html">Click here</xref> for a frameless version of this page where
      the links should work.</note>

    <section id="about">
      <p>You may have a need to recover your system if you have lost power or control nodes running
        clustering software have gone down.</p>
      <p>The steps involved are:</p>
      <ol>
        <li><xref href="add_node.dita#add_node/prereqs">Prerequisites</xref></li>
        <li><xref href="add_node.dita#add_node/recover">Recovering the Cluster</xref></li>
      </ol>
    </section>

    <section id="prereqs"><title>Prerequisites</title>
      <p>You must be able to power on all of the control planes before continuing.</p>
    </section>

    <section id="recover"><title>Recovering the Cluster</title>
      <p>You will need to power on all of the control planes before bootstrapping the MySQL cluster.
        To bootstrap a downed MySQL cluster, you will need to discover the last node to go down and
        run bootstrap on that node. Since the cluster didn't go down cleanly, you will need to SSH
        into each control node and run the following commands to find the node with the highest
        sequence number. When you find the node with the highest sequence number, you will need to
        run the bootstrap on that node. </p>
      <ol>
        <li>SSH into each control node. <note type="important">In this example, two nodes have the
            same sequence number which means you can run the bootstrap on either node but you can
            only run the bootstrap command once and only on one node. </note>
          <codeblock>sudo /usr/bin/mysqld_safe --wsrep-recover
sudo grep --text 'log sequence number' /var/log/mysql/error.log | tail -1</codeblock>
          <p>Here is an example showing the output from a three controller node cluster:</p>
          <codeblock>stack@padawan-ccp-c1-m1-mgmt:~$ sudo /usr/bin/mysqld_safe --wsrep-recover
stack@padawan-ccp-c1-m1-mgmt:~$ sudo grep --text 'log sequence number' /var/log/mysql/error.log | tail -1 
151119 14:37:12 InnoDB: Shutdown completed; log sequence number 165002105 

stack@padawan-ccp-c1-m2-mgmt:~$ sudo /usr/bin/mysqld_safe --wsrep-recover 
stack@padawan-ccp-c1-m2-mgmt:~$ sudo grep --text 'log sequence number' /var/log/mysql/error.log | tail -1 
151119 14:53:22 Percona XtraDB (http://www.percona.com) 5.5.41-37.0 started; log sequence number 165252407

stack@padawan-ccp-c1-m3-mgmt:~$ sudo /usr/bin/mysqld_safe --wsrep-recover
stack@padawan-ccp-c1-m3-mgmt:~$ sudo grep --text 'log sequence number' /var/log/mysql/error.log | tail -1 
151119 14:53:22 Percona XtraDB (http://www.percona.com) 5.5.41-37.0 started; log sequence number 165252407 
151119 14:53:23 InnoDB: Shutdown completed; log sequence number 165252407 </codeblock>
        </li>
        <li>Bootstrap the cluster.
          <codeblock>ssh padawan-ccp-c1-m2-mgmt
sudo /etc/init.d/mysql bootstrap-pxc
sudo service mysql restart</codeblock>
        </li>

        <li>Log onto the other two controller nodes and run mysql start.
          <codeblock>sudo service mysql start</codeblock>
        </li>
        <li>Log into the lifecycle manager and execute the hlm-start playbook for the 3 controller
          nodes.
          <codeblock>cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts hlm-start.yml --limit=padawan-ccp-c1-m1-mgmt,padawan-ccp-c1-m2-mgmt,padawan-ccp-c1-m3-mgmt</codeblock>
        </li>
        <li>Now run the hlm-start playbook for all nodes. When this playbook completes, all services
          should be started.
          <codeblock>cd ~/scratch/ansible/next/hos/ansible
ansible-playbook -i hosts/verb_hosts hlm-start.yml</codeblock>
        </li>
      </ol>
    </section>
  </body>
</topic>
